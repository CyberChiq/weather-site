<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live US Weather Radar & Alerts</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <style>
    :root { --bg:#0b0d12; --fg:#f2f5f9; --muted:#9aa4b2; --accent:#49a6ff; --danger:#ff4d4f; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--fg); }
    header { padding:16px 20px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; border-bottom:1px solid #1a222f; }
    .brand { font-weight:700; letter-spacing:.3px; }
    .cta { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { background:#141a24; color:var(--fg); border:1px solid #1f2a3a; padding:8px 12px; border-radius:8px; text-decoration:none; cursor:pointer; }
    .btn.accent { border-color: var(--accent); }
    .btn.danger { border-color: var(--danger); }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; padding:16px; }
    @media(min-width: 980px){ .grid { grid-template-columns: 2fr 1fr; } }
    .card { background:#0f141d; border:1px solid #182233; border-radius:12px; overflow:hidden; }
    .card h2 { margin:0; padding:12px 14px; font-size:1rem; border-bottom:1px solid #182233; color:#e8eef7; }
    .video-wrap { position:relative; padding-top:56.25%; }
    .video-wrap iframe { position:absolute; inset:0; width:100%; height:100%; border:0; }
    #map { width:100%; height:560px; }
    .panel { padding:12px 14px; }
    .muted { color:var(--muted); font-size:.9rem; }
    .alerts-list { display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto; padding:12px; }
    .alert { border:1px solid #24334a; border-left:4px solid var(--danger); border-radius:8px; padding:10px 12px; background:#0d131b; }
    .alert-title { font-weight:600; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 0; }
    input, select { background:#0b1118; color:var(--fg); border:1px solid #1f2a3a; border-radius:8px; padding:8px 10px; }
    .legend { position:absolute; bottom:12px; right:12px; background:#0b1118cc; color:#e8eef7; padding:8px 10px; border-radius:8px; border:1px solid #1f2a3a; font-size:.85rem; }
    .attribution { padding:10px 14px; font-size:.8rem; color:var(--muted); border-top:1px solid #182233; }
  </style>
</head>
<body>
  <header>
    <div class="brand">US Live Radar & Weather Alerts</div>
    <div class="cta">
      <a class="btn accent" href="https://www.youtube.com/live/rivJ9lgNZU8?si=1LWv9y4rLt22JLOW" target="_blank" rel="noopener" target="_blank" rel="noopener">Subscribe on YouTube</a>
      <a class="btn" href="#alerts">View Alerts</a>
      <a class="btn danger" href="#support">Support the Stream</a>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Live Stream</h2>
      <div class="video-wrap">
        <iframe
          src="https://www.youtube.com/embed/rivJ9lgNZU8?autoplay=0&modestbranding=1&rel=0"
          title="YouTube live"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
      </div>
      <div class="attribution">
        Tip: click the ‚ÄúView Alerts‚Äù button to see active NWS alerts and pan the map to your area.
      </div>
    </section>

    <aside class="card" id="alerts">
      <h2>Active Weather Alerts (NWS)</h2>
      <div class="panel">
        <div class="muted">Filter by your area:</div>
        <div class="controls">
          <input id="zip" placeholder="ZIP code (e.g., 80903)" />
          <button class="btn" id="locate">Use my location</button>
          <button class="btn" id="applyZip">Go</button>
        </div>
      </div>
      <div class="alerts-list" id="alertsList">
        <div class="muted">Loading alerts‚Ä¶</div>
      </div>
      <div class="attribution">
        Alerts: National Weather Service API ‚Ä¢ Radar: RainViewer tiles ‚Ä¢ Map: ¬© OpenStreetMap contributors
      </div>
    </aside>

    <section class="card" style="grid-column: 1 / -1;">
      <h2>Interactive Radar</h2>
      <div id="map"></div>
      <div class="legend">Radar intensity ‚Üë ‚Ä¢ Use pinch/scroll to zoom ‚Ä¢ Click features for details</div>
      <div class="attribution">
        Data/tiles subject to provider availability. Always follow local officials & NWS guidance.
      </div>
    </section>

    <section class="card" id="support" style="grid-column: 1 / -1;">
      <h2>Support & Updates</h2>
      <div class="panel">
        <p>Enjoying the stream? Subscribes & shares help a ton. Consider leaving a üëç on the live chat!</p>
        <form onsubmit="event.preventDefault(); alert('Thanks! This is a placeholder ‚Äî connect your provider form here.');">
          <label class="muted">Get severe weather emails for your state:</label><br/>
          <input type="email" required placeholder="you@example.com" />
          <select>
            <option value="">Select state‚Ä¶</option>
            <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option><option>CO</option>
            <option>CT</option><option>DE</option><option>FL</option><option>GA</option><option>HI</option><option>ID</option>
            <option>IL</option><option>IN</option><option>IA</option><option>KS</option><option>KY</option><option>LA</option>
            <option>ME</option><option>MD</option><option>MA</option><option>MI</option><option>MN</option><option>MS</option>
            <option>MO</option><option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
            <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option><option>OK</option>
            <option>OR</option><option>PA</option><option>RI</option><option>SC</option><option>SD</option><option>TN</option>
            <option>TX</option><option>UT</option><option>VT</option><option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
          </select>
          <button class="btn accent" type="submit">Sign up</button>
        </form>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Map ---
    const map = L.map('map', { zoomControl: true }).setView([39.5, -98.35], 4); // US center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 10, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // RainViewer radar tiles (keep attribution per their terms)
    const radar = L.tileLayer('https://tilecache.rainviewer.com/v2/radar/{z}/{x}/{y}/2/1_1.png', {
      opacity: 0.8, zIndex: 3, attribution: 'Radar ¬© RainViewer'
    }).addTo(map);

    // --- Alerts (NWS CAP API) ---
    const alertsList = document.getElementById('alertsList');
    let alertLayer = L.geoJSON(null, {
      style: f => ({ color:'#ff4d4f', weight:2, fill:false }),
      onEachFeature: (f, layer) => {
        const props = f.properties || {};
        const t = props.event || 'Alert';
        const a = props.areaDesc || '';
        const s = props.severity || '';
        const e = props.effective ? new Date(props.effective).toLocaleString() : '';
        layer.bindPopup(`<strong>${t}</strong><br>${a}<br><em>${s}</em><br>${e}`);
      }
    }).addTo(map);

    async function loadAlerts(params = {}) {
      alertsList.innerHTML = '<div class="muted">Loading alerts‚Ä¶</div>';
      try {
        let url = 'https://api.weather.gov/alerts/active?';
        if (params.point) {
          url += `point=${params.point.lat},${params.point.lon}`;
        } else if (params.area) {
          url += `area=${encodeURIComponent(params.area)}`;
        } else {
          url += 'status=actual&message_type=alert';
        }
        url += '&limit=200';

        const res = await fetch(url, { headers: { 'Accept': 'application/geo+json' }});
        const geo = await res.json();

        if (!geo.features || !geo.features.length) {
          alertsList.innerHTML = '<div class="muted">No active alerts for the current filter.</div>';
        } else {
          alertsList.innerHTML = '';
          geo.features.forEach(f => {
            const p = f.properties || {};
            const div = document.createElement('div');
            div.className = 'alert';
            div.innerHTML = `
              <div class="alert-title">${p.event || 'Alert'}</div>
              <div class="muted">${p.areaDesc || ''}</div>
              <div class="muted">${p.severity || ''} ‚Ä¢ ${p.urgency || ''}</div>
              <div class="muted">${p.sent ? new Date(p.sent).toLocaleString() : ''}</div>`;
            alertsList.appendChild(div);
          });
        }

        alertLayer.clearLayers();
        alertLayer.addData(geo);
      } catch (e) {
        alertsList.innerHTML = '<div class="muted">Failed to load alerts (NWS API). Try again later.</div>';
        console.error(e);
      }
    }
    loadAlerts();

    // --- ZIP and Geolocation helpers ---
    document.getElementById('applyZip').addEventListener('click', async () => {
      const zip = document.getElementById('zip').value.trim();
      if (!zip) return;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&postalcode=${encodeURIComponent(zip)}`);
        const data = await res.json();
        if (data && data[0]) {
          const { lat, lon } = data[0];
          map.setView([+lat, +lon], 7);
          loadAlerts({ point: { lat:+lat, lon:+lon } });
        }
      } catch (e) { console.error(e); }
    });

    document.getElementById('locate').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Location not supported.');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lon } = pos.coords;
        map.setView([lat, lon], 7);
        loadAlerts({ point: { lat, lon } });
      });
    });
  </script>
</body>
</html>
